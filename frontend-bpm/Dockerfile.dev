# =========================================
# Stage 1: Development - Angular Application
# =========================================

# Define the Node.js version to use (Alpine for a small footprint)
ARG NODE_VERSION=22-slim

# Set the base image for development
FROM node:${NODE_VERSION} AS dev

# Set environment variable to indicate development mode
ENV NODE_ENV=development

# Set the working directory inside the container
WORKDIR /app

# Copy only the dependency files first to optimize Docker caching
COPY package.json package-lock.json ./

# Install dependencies using npm with caching to speed up subsequent builds
RUN --mount=type=cache,target=/root/.npm npm install

# Copy all application source files into the container
COPY . .

# Expose the port that is used by the application (8080, matching compose.dev.yaml)
EXPOSE 8080

# Start the Angular dev server:
# 1. --host 0.0.0.0: Allows the server to listen on all network interfaces.
# 2. --port 8080: Explicitly sets the port to match the compose file mapping (Host 8080 -> Container 8080).
# 3. --allowed-hosts=all: This is the replacement for --disable-host-check. It allows connections from any host/IP, 
#    which is necessary when the browser connects via a mapped port (8080) to a different IP (the container's IP).
CMD ["npm", "start", "--", "--host=0.0.0.0", "--port=8080", "--allowed-hosts=all"]